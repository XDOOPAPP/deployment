version: "3.8"

services:
  api-gateway:
    build:
      context: ../api-gateway
      dockerfile: Dockerfile
    container_name: fepa-api-gateway
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
      - AUTH_SERVICE_HOST=auth-service
      - AUTH_SERVICE_PORT=3001
      - EXPENSE_SERVICE_HOST=expense-service
      - EXPENSE_SERVICE_PORT=3002
      - BUDGET_SERVICE_HOST=budget-service
      - BUDGET_SERVICE_PORT=3003
      - BLOG_SERVICE_HOST=blog-service
      - BLOG_SERVICE_PORT=3004
      - SUBSCRIPTION_SERVICE_HOST=subscription-service
      - SUBSCRIPTION_SERVICE_PORT=3005
      - NOTIFICATION_SERVICE_HOST=notification-service
      - NOTIFICATION_SERVICE_PORT=3006
      - OCR_SERVICE_HOST=ocr-service
      - OCR_SERVICE_PORT=3007
      - AI_SERVICE_HOST=ai-service
      - AI_SERVICE_PORT=3008
    depends_on:
      rabbitmq:
        condition: service_healthy
      auth-service:
        condition: service_started
      expense-service:
        condition: service_started
      budget-service:
        condition: service_started
      blog-service:
        condition: service_started
      subscription-service:
        condition: service_started
      notification-service:
        condition: service_started
      ocr-service:
        condition: service_started
      ai-service:
        condition: service_started
    networks:
      - fepa-network

  auth-service:
    build:
      context: ../auth-service
      dockerfile: Dockerfile
    container_name: fepa-auth-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3001
      - HTTP_PORT=4001
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  expense-service:
    build:
      context: ../expense-service
      dockerfile: Dockerfile
    container_name: fepa-expense-service
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3002
      - HTTP_PORT=4002
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  budget-service:
    build:
      context: ../budget-service
      dockerfile: Dockerfile
    container_name: fepa-budget-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3003
      - HTTP_PORT=4003
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  blog-service:
    build:
      context: ../blog-service
      dockerfile: Dockerfile
    container_name: fepa-blog-service
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3004
      - HTTP_PORT=4004
      - DATABASE_URL=postgresql://fepa:fepa123@postgres:5432/fepa_db?schema=blog
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - fepa-network

  subscription-service:
    build:
      context: ../subscription-service
      dockerfile: Dockerfile
    container_name: fepa-subscription-service
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3005
      - HTTP_PORT=4005
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  notification-service:
    build:
      context: ../notification-service
      dockerfile: Dockerfile
    container_name: fepa-notification-service
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3006
      - HTTP_PORT=4006
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  ocr-service:
    build:
      context: ../ocr-service
      dockerfile: Dockerfile
    container_name: fepa-ocr-service
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3007
      - HTTP_PORT=4007
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  ai-service:
    build:
      context: ../ai-service
      dockerfile: Dockerfile
    container_name: fepa-ai-service
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=development
      - TCP_PORT=3008
      - HTTP_PORT=4008
      - RABBITMQ_URL=amqp://fepa:fepa123@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fepa-network

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: fepa-rabbitmq
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=fepa
      - RABBITMQ_DEFAULT_PASS=fepa123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - fepa-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:15-alpine
    container_name: fepa-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=fepa
      - POSTGRES_PASSWORD=fepa123
      - POSTGRES_DB=fepa_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - fepa-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U fepa" ]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: fepa-pgadmin
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@fepa.com
      - PGADMIN_DEFAULT_PASSWORD=admin123
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - fepa-network
    restart: unless-stopped

networks:
  fepa-network:
    driver: bridge

volumes:
  postgres_data:
  pgadmin_data:
  rabbitmq_data:
